// actually mai chahta hu ki mai dynamically kisi bhi esp32 ko control kar saku dynamically uski ip change karke. means kal ko agr mujhe koi new esp32 wifi switch lgani ho to mai kaise lgaunga us chiz ko apne app ke through to maine apne app me ye functionality dali hai ki
// mai ifi ka ssid aur password ko apne mobile ke app se hi dal saku

#include <WiFi.h>
#include <SocketIOclient.h>
#include <ArduinoJson.h>
#include <Preferences.h>
#include <ESPmDNS.h>

const char* default_ssid = "Redmi10";
const char* default_password = "1234abcd";
const char* host = "192.168.154.76";
const uint16_t port = 5000;
const char* path = "/socket.io/?EIO=4";

SocketIOclient socketIO;
Preferences preferences;

const int ledPin = 2;

void saveWiFiCredentials(const char* ssid, const char* password) {
  preferences.begin("wifi", false);
  preferences.putString("ssid", ssid);
  preferences.putString("password", password);
  preferences.end();
}

void handleDeviceUpdate(const char* payload) {
  DynamicJsonDocument doc(1024);
  DeserializationError error = deserializeJson(doc, payload);

  if (error) {
    Serial.print("JSON Parse Error: ");
    Serial.println(error.c_str());
    return;
  }

  if (!doc.is<JsonArray>()) return;

  const char* eventName = doc[0];
  JsonObject data = doc[1];

  if (strcmp(eventName, "device_update") == 0) {
    const char* device = data["device"];
    const char* status = data["status"];

    if (strcmp(device, "DOOR LOCK") == 0) {
      if (strcmp(status, "LOCKED") == 0) {
        digitalWrite(ledPin, LOW);
        Serial.println("LED ON: DOOR LOCKED");
      } else if (strcmp(status, "UNLOCK") == 0) {
        digitalWrite(ledPin, HIGH);
        Serial.println("LED OFF: DOOR UNLOCKED");
      }
    }
  } else if (strcmp(eventName, "wifi_config") == 0) {
    JsonObject wifiData = data;
    const char* ssid = wifiData["ssid"];
    const char* password = wifiData["password"];

    Serial.printf("Received new WiFi credentials: %s / %s\n", ssid, password);
    saveWiFiCredentials(ssid, password);

    Serial.println("Restarting ESP to apply new WiFi...");
    delay(2000);
    ESP.restart();
  }
}

void onSocketEvent(socketIOmessageType_t type, uint8_t * payload, size_t length) {
  switch (type) {
    case sIOtype_CONNECT:
      Serial.println("[SocketIO] Connected.");
      socketIO.send(sIOtype_CONNECT, "/");
      break;

    case sIOtype_EVENT:
      Serial.print("[SocketIO] Received: ");
      Serial.write(payload, length);
      Serial.println();
      handleDeviceUpdate((const char*)payload);
      break;

    case sIOtype_DISCONNECT:
      Serial.println("[SocketIO] Disconnected.");
      break;

    case sIOtype_ERROR:
      Serial.println("[SocketIO] Error.");
      break;

    default:
      break;
  }
}

void setup() {
  Serial.begin(115200);
  pinMode(ledPin, OUTPUT);
  digitalWrite(ledPin, LOW);

  preferences.begin("wifi", true);
  String saved_ssid = preferences.getString("ssid", default_ssid);
  String saved_pass = preferences.getString("password", default_password);
  preferences.end();

  Serial.printf("Connecting to WiFi: %s\n", saved_ssid.c_str());
  WiFi.begin(saved_ssid.c_str(), saved_pass.c_str());

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi connected. IP address: ");
  Serial.println(WiFi.localIP());

  if (!MDNS.begin("esp32")) {  // You can change "esp32" to any unique name
    Serial.println("Error setting up mDNS responder!");
  } else {
    Serial.println("mDNS responder started. Access with http://esp32.local");
  }

  socketIO.begin(host, port, path);
  socketIO.onEvent(onSocketEvent);
}

void loop() {
  socketIO.loop();
}

//EX-2 flask code 
from flask import Flask, request
from flask_socketio import SocketIO, emit
import json

app = Flask(__name__)
app.config['SECRET_KEY'] = 'secret!'
socketio = SocketIO(app, cors_allowed_origins="*", async_mode="eventlet")

# Store device states
devices = {
    'DOOR LOCK': 'LOCKED',
    'DOWNLIGHTS': 'OFF',
    'BEDROOM': 'OFF',
    'TV': 'OFF',
    'SPEAKER R': 'OFF',
    'SPEAKER L': 'OFF',
    'IWATCH': 'OFF',
    'AIRCND': 'OFF'
}

@app.route('/')
def index():
    return "Flask-SocketIO Server Running"

@socketio.on('connect')
def handle_connect():
    print('Client connected')
    emit('device_states', devices)

@socketio.on('disconnect')
def handle_disconnect():
    print('Client disconnected')

@socketio.on('device_status')
def handle_device_status(data):
    print(f"Received command: {data}")
    try:
        device = data.get('device')
        status = data.get('status')

        if device in devices:
            devices[device] = status
            emit('device_update', {'device': device, 'status': status}, broadcast=True)
        else:
            print("Unknown device:", device)
    except Exception as e:
        print("Error handling command:", e)
        
# Receive Wi-Fi configuration from Flutter app
@socketio.on('wifi_config')
def handle_wifi_config(data):
    try:
        mdns = data.get('mdns')
        wifi_config = data.get('data')
        ssid = wifi_config.get('ssid')
        password = wifi_config.get('password')

        print(f"Received Wi-Fi config from Flutter: mDNS = {mdns}, SSID = {ssid}, Password = {password}")
        emit('wifi_config', {'ssid': ssid, 'password': password}, room='esp32')

    except Exception as e:
        print("Error handling Wi-Fi config:", e)

if __name__ == '__main__':
    socketio.run(app, host='0.0.0.0', port=5000)
